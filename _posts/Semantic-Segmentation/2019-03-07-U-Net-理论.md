---
layout: post
title: U-Net 理论
category: 语义分割
tags: unet
description:
---

*医学影像分割的基石*

## 一、背景

在分割问题中，池化层的存在不仅能增大上层卷积核的感受野，而且能聚合背景同时丢弃部分位置信息。然而，语义分割方法需对类别图谱进行精确调整，因此需保留池化层中所舍弃的位置信息。

研究者提出了一种编码器-解码器 (encoder-decoder) 结构。其中，编码器使用池化层逐渐缩减输入数据的空间维度，而解码器通过反卷积层等网络层逐步恢复目标的细节和相应的空间维度。从编码器到解码器之间，通常存在直接的信息连接，来帮助解码器更好地恢复目标细节。在这种方法中，一种典型结构为U-Net网络。

## 二、 网络结构

![](https://raw.githubusercontent.com/chiemon/chiemon.github.io/master/img/UNet/1.png)

整体结构就是先编码（下采样）， 再解码（上采样），回归到跟原始图像一样大小的像素点的分类。

- 首先是输入图像的大小，这个是根据最高层的大小来进行反推的，最后取的一个比较合适的方便计算的输入大小。
- 下采样是通过max pool 2x2来进行1/2下采样的，下采样之间是两个conv卷积层，这里的卷积是使用 valid 卷积。所以在卷积过程中图像的大小是会减小的。

    这会造成一个问题，就是造成了在skip connection部分concat时候大小不一致，因为在上面有一个copy & crop操作，crop就是为了将大小进行裁剪的操作。

- 上采样，相对于FCN的转置卷积进行上采样，这里是一个up-conv 2x2，具体对应的操作是：对行列进行2倍翻倍。

## 三、U-Net 与 FCN

### 1. 继承

U-Net 继承 FCN 的思想，继续进行改进。但是相对于FCN，有几个改变的地方，U-Net是完全对称的，且对解码器（应该自Hinton提出编码器、解码器的概念来，即将图像->高语义feature map的过程看成编码器，高语义->像素级别的分类score map的过程看作解码器）进行了加卷积加深处理，FCN只是单纯的进行了上采样。

### 2. Skip Connection

两者都用了这样的结构，虽然在现在看来这样的做法比较常见，但是对于当时，这样的结构所带来的明显好处是有目共睹的，因为可以联合高层语义和低层的细粒度表层信息，就很好的符合了分割对这两方面信息的需求。

### 3. 联合

在 FCN 中，Skip connection 的联合是通过对应像素的求和，而U-Net则是对其的 channel 的 concat 过程。

## 四、Overlap-tile 策略

Overlap-tile 策略：用于无缝分割任意大图像的重叠平铺策略 （这里是 EM 堆栈中神经元结构的分割）。

![](https://raw.githubusercontent.com/chiemon/chiemon.github.io/master/img/UNet/2.png)

医学图像是一般相当大，但是分割时候不可能将原图太小输入网络，所以必须切成一张一张的小 patch，在切成小 patch 的时候，UNet 由于网络结构原因适合有 overlap 的切图，可以看图，红框是要分割区域，但是在切图时要包含周围区域，overlap 另一个重要原因是周围 overlap 部分可以为分割区域边缘部分提供文理等信息。可以看黄框的边缘，分割结果并没有受到切成小patch而造成分割情况不好。

## 五、损失函数

这篇论文中优化用的是 SGD with momentum。能量函数，用了加权的交叉熵形式，而不是通常的平均形式：

![](https://raw.githubusercontent.com/chiemon/chiemon.github.io/master/img/UNet/3.png)

其中

![](https://raw.githubusercontent.com/chiemon/chiemon.github.io/master/img/UNet/4.png)

即像素点形式的softmax。

其中 w(x) 表示训练构成中像素点的重要性，越重要权重越大。由于分割问题边界处的分割一直是难题，因此本文赋予边界处更高的权重以达到精确分割：

![](https://raw.githubusercontent.com/chiemon/chiemon.github.io/master/img/UNet/5.png)

![](https://raw.githubusercontent.com/chiemon/chiemon.github.io/master/img/UNet/6.png)

实验中 W0 = 10，标准差为 5，Wc 是类别频率的权值，d1 表示此像素点到离他最近的 cell 的边界的距离，d2 表示此像素点到离他第二近的cell的边界的距离。这样离边界越近的像素点权重越大，因而也会被着重训练。

## 六、实验结果

![](https://raw.githubusercontent.com/chiemon/chiemon.github.io/master/img/UNet/7.png)

![](https://raw.githubusercontent.com/chiemon/chiemon.github.io/master/img/UNet/8.png)