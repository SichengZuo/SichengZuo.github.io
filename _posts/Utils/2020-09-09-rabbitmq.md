---
layout: post
title: rabbitmq
category: Utils
tags: rabbitmq
keywords: rabbitmq
description:
---

### rabbitmq-server install

#### local

1. 安装
```bash
# 安装 openssl 依赖
sudo apt-get install libssl-dev

# 添加源
echo 'deb http://www.rabbitmq.com/debian/ testing main' |
        sudo tee /etc/apt/sources.list.d/rabbitmq.list

# 更新源
sudo apt-get update

# 安装 rabbitmq-server
sudo apt-get install rabbitmq-server
# 如安装失败，添加公钥到信任列表
wget http://www.rabbitmq.com/rabbitmq-signing-key-public.asc

# 启动 web 监控
sudo rabbitmq-server

# 开启 Web 管理插件
sudo rabbitmq-plugins enable rabbitmq_management

# 查看服务
sudo rabbitmq-plugins list
```

2. 启动、关闭

```bash
# 启动
sudo service rabbitmq-server start

# 关闭
sudo rabbitmqctl stop

# 设置开机自启
sudo chkconfig rabbitmq-server on
```

3. 用户

*guest只能本地访问*

- 添加

```bash
# 新建用户
rabbitmqctl add_user <用户名> <密码>

# 设定用户 administrator 角色
rabbitmqctl set_user_tags <用户名> administrator

# 赋予用户权限
rabbitmqctl set_permission -p / <用户名> ".*" ".*" ".*"
```

- 查询

```bash
# 查看所有账号
rabbitmqctl list_users

# 修改密码
rabbitmqctl change_password <用户名> <新密码>

# 删除用户
rabbitmqctl delete_user <用户名>
```

4. c++ 中使用 rabbitmq

- 1. 安装 rabbitmq-c

```bash
git clone https://github.com/alanxz/rabbitmq-c

cd rabbitmq-c

git clone https://github.com/rabbitmq/rabbitmq-codegen.git

mv rabbitmq-codegen codegen  // 重命名 codegen

mkdir build

cd build

cmake ..

cmake --build .

make
```

- 2. ev、eu、libevent 等事件循环的支持

```bash
sudo apt install libev-dev
sudo apt install libuv1-dev
sudo apt install libevent1-dev
sudo apt-get install libevent-dev
```

- 3. 安装带 linux-tcp 配置的 AMQP-CPP

```bash
git clone https://github.com/CopernicaMarketingSoftware/AMQP-CPP.git
cd AMQP-CPP
mkdir build
cd build
```

- 4. 修改 AMQP-CPP 中的 CMakeList.txt 打开 linux-tcp 和 so 动态库，同时可以把 example 也顺带编译一下

```bash
option(AMQP-CPP_BUILD_SHARED "Build shared library. If off, build will be static." ON)
option(AMQP-CPP_LINUX_TCP "Build linux sockets implementation." ON)
option(AMQP-CPP_BUILD_EXAMPLES "Build amqpcpp examples" ON)
```

- 5. 编译安装

```bash
cmake ..
make
sudo make install
```

#### docker

1. 获取镜像
```bash
# 查询镜像文件
docker search rabbitmq

# 拉取镜像文件
docker pull rabbitmq:3.7-management
```

2. 启动
```bash
docker run -it -d --hostname my-rabbit --name rabbit -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=admin -p 15672:15672 -p 5672:5672 rabbitmq:3.7-management
```

- RABBITMQ_DEFAULT_USER：账号
- RABBITMQ_DEFAULT_PASS：密码
- 如果 RABBITMQ_DEFAULT_USER 和 RABBITMQ_DEFAULT_PASS 没填写，默认用户 guest 密码 guest
- 15672：控制台端口
- 5672： AMQP端口
